{% extends "base.html" %}

{% block title %}ì§€í•˜ì²  ì‹¤ì‹œê°„ ë„ì°© ì •ë³´{% endblock title %}

{% block style %}
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }

    table {
        border-collapse: collapse;
        width: 100%;
    }

    th,
    td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
        font-size: 14px;
    }

    th {
        background-color: #f4f4f4;
    }

    tr.arrived {
        background-color: #d4edda;
    }

    tr.departed {
        background-color: #fff3cd;
    }

    .last-train {
        color: red;
        font-weight: bold;
    }

    .control-box {
        margin-bottom: 15px;
    }

    .control-box button {
        padding: 8px 14px;
        margin-right: 6px;
        font-size: 14px;
        cursor: pointer;
    }

    .btn-start {
        background: #28a745;
        color: white;
        border: none;
    }

    .btn-stop {
        background: #dc3545;
        color: white;
        border: none;
    }

    .btn-test {
        background: #007bff;
        color: white;
        border: none;
    }
</style>
{% endblock style %}

{% block content %}
<h2>ğŸš‡ {{ station }} ì‹¤ì‹œê°„ ë„ì°© ì •ë³´</h2>

<div class="control-box">
    <button id="startVoice" class="btn-start">ğŸ”Š ì•ˆë‚´ ì‹œì‘</button>
    <button id="stopVoice" class="btn-stop">ğŸ”‡ ì•ˆë‚´ ì¢…ë£Œ</button>
    <button id="testVoice" class="btn-test">â–¶ í…ŒìŠ¤íŠ¸ ìŒì„±</button>
</div>

<table>
    <thead>
        <tr>
            <th>ì—´ì°¨ë²ˆí˜¸</th>
            <th>ìƒ/í•˜í–‰</th>
            <th>í–‰ì„ ì§€</th>
            <th>ì—´ì°¨ì¢…ë¥˜</th>
            <th>ë„ì°©ê¹Œì§€</th>
            <th>ë„ì°©ë©”ì‹œì§€</th>
            <th>ë§‰ì°¨</th>
        </tr>
    </thead>
    <tbody>
        {% for t in trains %}
        <tr data-train="{{ t.train_no }}" data-code="{{ t.arrival_code }}" data-msg="{{ t.msg1 }}" class="
                {% if t.arrival_code == '1' %}arrived
                {% elif t.arrival_code == '2' %}departed
                {% endif %}
            ">
            <td>{{ t.train_no }}</td>
            <td>{{ t.line }}</td>
            <td>{{ t.destination }}</td>
            <td>{{ t.train_type }}</td>
            <td>
                {% if t.arrival_sec == "0" %}
                ê³§ ë„ì°©
                {% else %}
                {{ t.arrival_sec }}ì´ˆ
                {% endif %}
            </td>
            <td>{{ t.msg1 }} {{ t.msg2 }}</td>
            <td>
                {% if t.is_last %}
                <span class="last-train">ë§‰ì°¨</span>
                {% else %}
                -
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    /* ===== ì„¤ì • ===== */
    const TARGET_TRAINS = ["515", "217", "821", "230"];
    let voiceEnabled = false;
    const announced = new Set();

    /* ===== ìŒì„± ===== */
    function speak(text) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = "ko-KR";
        speechSynthesis.speak(msg);
    }

    /* ===== ë²„íŠ¼ ===== */
    document.getElementById("startVoice").addEventListener("click", () => {
        voiceEnabled = true;
        speak("ì—´ì°¨ ë„ì°© ìŒì„± ì•ˆë‚´ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");
    });

    document.getElementById("stopVoice").addEventListener("click", () => {
        voiceEnabled = false;
        speechSynthesis.cancel();
    });

    document.getElementById("testVoice").addEventListener("click", () => {
        speak("ìŒì„± í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì†Œë¦¬ê°€ ì •ìƒì ìœ¼ë¡œ ë“¤ë¦½ë‹ˆë‹¤.");
    });

    /* ===== ë„ì°© íŒë‹¨ ===== */
    function checkArrivalVoice() {
        if (!voiceEnabled) return;

        document.querySelectorAll("tbody tr").forEach(row => {
            const trainNo = row.dataset.train;
            const code = row.dataset.code;
            const msg = row.dataset.msg || "";

            if (!TARGET_TRAINS.includes(trainNo)) return;

            let stage = null;

            if (code === "1") stage = "ë‹¹ì—­";
            else if (code === "4" || msg.includes("ì „ì—­")) stage = "ì „ì—­";
            else if (code === "99") stage = "ì „ì „ì—­";

            if (!stage) return;

            const key = `${trainNo}-${stage}`;
            if (announced.has(key)) return;

            announced.add(key);
            speak(`${trainNo}ë²ˆ ì—´ì°¨ê°€ ${stage}ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.`);
        });
    }

    /* ìµœì´ˆ 1íšŒ */
    checkArrivalVoice();

    /*
    âš ï¸ í˜ì´ì§€ê°€ 10ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨ë˜ëŠ” êµ¬ì¡°ë¼ë©´
    ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ì•ˆë‚´ë¥¼ ì›í•˜ë©´:
    - localStorage ë¡œ voiceEnabled ì €ì¥ ê°€ëŠ¥
    */
</script>
{% endblock content %}